!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){a(window).bind("unload.atmosphere",function(){a.atmosphere.debug(new Date+" Atmosphere: unload event"),a.atmosphere.unsubscribe()}),a(window).bind("beforeunload.atmosphere",function(){a.atmosphere.debug(new Date+" Atmosphere: beforeunload event"),a.atmosphere._beforeUnloadState=!0,setTimeout(function(){a.atmosphere.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),a.atmosphere._beforeUnloadState=!1},5e3)}),a(window).bind("offline",function(){a.atmosphere.offline=!0;for(var b=[].concat(a.atmosphere.requests),c=0;c<b.length;c++){var d=b[c];d.close(),clearTimeout(d.response.request.id),d.heartbeatTimer&&clearTimeout(d.heartbeatTimer)}}),a(window).bind("online",function(){if(a.atmosphere.offline=!1,a.atmosphere.requests.length>0)for(var b=0;b<a.atmosphere.requests.length;b++)a.atmosphere.requests[b].init(),a.atmosphere.requests[b].execute()}),a(window).keypress(function(a){27===a.keyCode&&a.preventDefault()});var c=function(a){for(var b,c=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,d={};b=c.exec(a);)d[b[1]]=b[2];return d};a.atmosphere={version:"2.2.12-jquery",uuid:0,offline:!1,requests:[],callbacks:[],onError:function(a){},onClose:function(a){},onOpen:function(a){},onMessage:function(a){},onReconnect:function(a,b){},onMessagePublished:function(a){},onTransportFailure:function(a,b){},onLocalMessage:function(a){},onClientTimeout:function(a){},onFailureToReconnect:function(a,b){},WebsocketApiAdapter:function(a){var b,c;return a.onMessage=function(a){c.onmessage({data:a.responseBody})},a.onMessagePublished=function(a){c.onmessage({data:a.responseBody})},a.onOpen=function(a){c.onopen(a)},c={close:function(){b.close()},send:function(a){b.push(a)},onmessage:function(a){},onopen:function(a){},onclose:function(a){},onerror:function(a){}},b=new $.atmosphere.subscribe(a),c},AtmosphereRequest:function(d){function x(){l=!0,p=!1,m=0,g=null,h=null,i=null,j=null}function y(){ya(),x()}function z(a){return"debug"==a?"debug"===e.logLevel:"info"==a?"info"===e.logLevel||"debug"===e.logLevel:"warn"==a?"warn"===e.logLevel||"info"===e.logLevel||"debug"===e.logLevel:"error"==a&&("error"===e.logLevel||"warn"===e.logLevel||"info"===e.logLevel||"debug"===e.logLevel)}function A(b){z("debug")&&a.atmosphere.debug(new Date+" Atmosphere: "+b)}function B(b){y(),e=a.extend(e,b),e.mrequest=e.reconnect,e.reconnect||(e.reconnect=!0)}function C(){return null!=e.webSocketImpl||window.WebSocket||window.MozWebSocket}function D(){function b(a){var b=document.createElement("div");return b.innerHTML='<a href="'+a+'"/>',encodeURI(decodeURI(b.firstChild.href))}var c=b(e.url.toLowerCase()),d=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(c),f=!(!d||d[1]==window.location.protocol&&d[2]==window.location.hostname&&(d[3]||("http:"===d[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443)));return window.EventSource&&(!f||!a.browser.safari||a.browser.vmajor>=7)}function E(){if(e.shared){if(s=F(e),null!=s&&(z("debug")&&a.atmosphere.debug("Storage service available. All communication will be local"),s.open(e)))return;z("debug")&&a.atmosphere.debug("No Storage service available."),s=null}e.firstMessage=0==a.atmosphere.uuid,e.isOpen=!1,e.ctime=a.now(),0===e.uuid&&(e.uuid=a.atmosphere.uuid),e.closedByClientTimeout=!1,"websocket"!==e.transport&&"sse"!==e.transport?Y(e):"websocket"===e.transport?C()?O(!1):U("Websocket is not supported, using request.fallbackTransport ("+e.fallbackTransport+")"):"sse"===e.transport&&(D()?N(!1):U("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+e.fallbackTransport+")"))}function F(b){function i(c){var d=a.parseJSON(c),g=d.data;if("c"===d.target)switch(d.type){case"open":H("opening","local",e);break;case"close":f||(f=!0,"aborted"===g.reason?xa():g.heir===t?E():setTimeout(function(){E()},100));break;case"message":pa(g,"messageReceived",200,b.transport);break;case"localMessage":oa(g)}}function j(){var b=new RegExp("(?:^|; )("+encodeURIComponent(g)+")=([^;]*)").exec(document.cookie);if(b)return a.parseJSON(decodeURIComponent(b[2]))}var c,d,f,g="atmosphere-"+b.url,h={storage:function(){if(a.atmosphere.supportStorage()){var c=window.localStorage,d=function(b){return a.parseJSON(c.getItem(g+"-"+b))},e=function(b,d){c.setItem(g+"-"+b,a.stringifyJSON(d))};return{init:function(){return e("children",d("children").concat([t])),a(window).on("storage.socket",function(a){a=a.originalEvent,a.key===g&&a.newValue&&i(a.newValue)}),d("opened")},signal:function(b,d){c.setItem(g,a.stringifyJSON({target:"p",type:b,data:d}))},close:function(){var c,f=d("children");a(window).off("storage.socket"),f&&(c=a.inArray(b.id,f),c>-1&&(f.splice(c,1),e("children",f)))}}}},windowref:function(){var b=window.open("",g.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){return b.callbacks.push(i),b.children.push(t),b.opened},signal:function(c,d){!b.closed&&b.fire&&b.fire(a.stringifyJSON({target:"p",type:c,data:d}))},close:function(){function c(b,c){var d=a.inArray(c,b);d>-1&&b.splice(d,1)}f||(c(b.callbacks,i),c(b.children,t))}}}};if(c=j(),c&&!(a.now()-c.ts>1e3)&&(d=h.storage()||h.windowref()))return{open:function(){var e;return u=setInterval(function(){var b=c;c=j(),c&&b.ts!==c.ts||i(a.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:b.heir}}))},1e3),e=d.init(),e&&setTimeout(function(){H("opening","local",b)},50),e},send:function(a){d.signal("send",a)},localSend:function(b){d.signal("localSend",a.stringifyJSON({id:t,event:b}))},close:function(){p||(clearInterval(u),d.signal("close"),d.close())}}}function G(){function f(b){var c=a.parseJSON(b),d=c.data;if("p"===c.target)switch(c.type){case"send":fa(d);break;case"localSend":oa(d);break;case"close":xa()}}function g(){document.cookie=v+"="+encodeURIComponent(a.stringifyJSON({ts:a.now()+1,heir:(b.get("children")||[])[0]}))+"; path=/"}var b,c="atmosphere-"+e.url,d={storage:function(){if(a.atmosphere.supportStorage()){var b=window.localStorage;return{init:function(){a(window).on("storage.socket",function(a){a=a.originalEvent,a.key===c&&a.newValue&&f(a.newValue)})},signal:function(d,e){b.setItem(c,a.stringifyJSON({target:"c",type:d,data:e}))},get:function(d){return a.parseJSON(b.getItem(c+"-"+d))},set:function(d,e){b.setItem(c+"-"+d,a.stringifyJSON(e))},close:function(){a(window).off("storage.socket"),b.removeItem(c),b.removeItem(c+"-opened"),b.removeItem(c+"-children")}}}},windowref:function(){var b=c.replace(/\W/g,""),d=(a('iframe[name="'+b+'"]')[0]||a('<iframe name="'+b+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){d.callbacks=[f],d.fire=function(a){var b;for(b=0;b<d.callbacks.length;b++)d.callbacks[b](a)}},signal:function(b,c){!d.closed&&d.fire&&d.fire(a.stringifyJSON({target:"c",type:b,data:c}))},get:function(a){return d.closed?null:d[a]},set:function(a,b){d.closed||(d[a]=b)},close:function(){}}}};q=function(c){b.signal("message",c)},b=d.storage()||d.windowref(),b.init(),z("debug")&&a.atmosphere.debug("Installed StorageService "+b),b.set("children",[]),null==b.get("opened")||b.get("opened")||b.set("opened",!1),v=encodeURIComponent(c),g(),u=setInterval(g,1e3),r=b}function H(a,b,c){if(e.shared&&"local"!==b&&G(),null!=r&&r.set("opened",!0),c.close=function(){xa()},m>0&&"re-connecting"===a)c.isReopen=!0,aa(f);else if(null==f.error){f.request=c;var d=f.state;f.state=a;var g=f.transport;f.transport=b;var h=f.responseBody;ua(),f.responseBody=h,f.state=d,f.transport=g}}function I(b){b.transport="jsonp";var c=e;null!=b&&"undefined"!=typeof b&&(c=b);var d=c.url;null!=c.dispatchUrl&&(d+=c.dispatchUrl);var g=c.data;c.attachHeadersAsQueryString&&(d=V(c),""!==g&&(d+="&X-Atmosphere-Post-Body="+encodeURIComponent(g)),g=""),k=a.ajax({url:d,type:c.method,dataType:"jsonp",error:function(a,b,d){f.error=!0,c.openId&&clearTimeout(c.openId),c.heartbeatTimer&&clearTimeout(c.heartbeatTimer),c.reconnect&&m++<c.maxReconnectOnClose?(H("re-connecting",c.transport,c),_(k,c,c.reconnectInterval),c.openId=setTimeout(function(){W(c)},c.reconnectInterval+1e3)):S(a.status,d)},jsonp:"jsonpTransport",success:function(b){if(c.reconnect)if(c.maxRequest===-1||c.requestCount++<c.maxRequest){qa(k,c);var d=b.message;if(null!=d&&"string"!=typeof d)try{d=a.stringifyJSON(d)}catch(a){}var g=T(d,c,f);c.executeCallbackBeforeReconnect||_(k,c,c.pollingInterval),g||pa(f.responseBody,"messageReceived",200,c.transport),c.executeCallbackBeforeReconnect&&_(k,c,c.pollingInterval),Q(c)}else a.atmosphere.log(e.logLevel,["JSONP reconnect maximum try reached "+e.requestCount]),S(0,"maxRequest reached")},data:c.data,beforeSend:function(a){$(a,c,!1)}})}function J(b){var c=e;null!=b&&"undefined"!=typeof b&&(c=b);var d=c.url;null!=c.dispatchUrl&&(d+=c.dispatchUrl);var g=c.data;c.attachHeadersAsQueryString&&(d=V(c),""!==g&&(d+="&X-Atmosphere-Post-Body="+encodeURIComponent(g)),g="");var h="undefined"==typeof c.async||c.async;k=a.ajax({url:d,type:c.method,error:function(a,b,d){f.error=!0,a.status<300?_(k,c):S(a.status,d)},success:function(b,d,g){if(c.reconnect)if(c.maxRequest===-1||c.requestCount++<c.maxRequest){c.executeCallbackBeforeReconnect||_(k,c,c.pollingInterval);var h=T(b,c,f);h||pa(f.responseBody,"messageReceived",200,c.transport),c.executeCallbackBeforeReconnect&&_(k,c,c.pollingInterval)}else a.atmosphere.log(e.logLevel,["AJAX reconnect maximum try reached "+e.requestCount]),S(0,"maxRequest reached")},beforeSend:function(a){$(a,c,!1)},crossDomain:c.enableXDR,async:h})}function K(a){return null!=e.webSocketImpl?e.webSocketImpl:window.WebSocket?new WebSocket(a):new MozWebSocket(a)}function L(){var b=V(e);return decodeURI(a('<a href="'+b+'"/>')[0].href.replace(/^http/,"ws"))}function M(){var a=V(e);return a}function N(b){f.transport="sse";var c=M(e.url);if(z("debug")&&(a.atmosphere.debug("Invoking executeSSE"),a.atmosphere.debug("Using URL: "+c)),b&&!e.reconnect)return void(null!=h&&ya());try{h=new EventSource(c,{withCredentials:e.withCredentials})}catch(a){return S(0,a),void U("SSE failed. Downgrading to fallback transport and resending")}e.connectTimeout>0&&(e.id=setTimeout(function(){b||ya()},e.connectTimeout)),h.onopen=function(c){A("websocket.onopen"),Q(e),z("debug")&&a.atmosphere.debug("SSE successfully opened"),e.enableProtocol?e.isReopen&&(e.isReopen=!1,H("re-opening",e.transport,e)):b?H("re-opening","sse",e):H("opening","sse",e),b=!0,"POST"===e.method&&(f.state="messageReceived",h.send(e.data))},h.onmessage=function(b){if(A("websocket.onmessage"),Q(e),!e.enableXDR&&b.origin!==window.location.protocol+"//"+window.location.host)return void a.atmosphere.log(e.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);f.state="messageReceived",f.status=200,b=b.data;var c=T(b,e,f);c||(ua(),f.responseBody="",f.messages=[])},h.onerror=function(c){A("websocket.onerror"),clearTimeout(e.id),e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),f.closedByClientTimeout||(ta(b),ya(),p?a.atmosphere.log(e.logLevel,["SSE closed normally"]):b?e.reconnect&&"sse"===f.transport&&(m++<e.maxReconnectOnClose?(H("re-connecting",e.transport,e),e.reconnectInterval>0?e.reconnectId=setTimeout(function(){N(!0)},e.reconnectInterval):N(!0),f.responseBody="",f.messages=[]):(a.atmosphere.log(e.logLevel,["SSE reconnect maximum try reached "+m]),S(0,"maxReconnectOnClose reached"))):U("SSE failed. Downgrading to fallback transport and resending"))}}function O(b){f.transport="websocket";var c=L(e.url);if(z("debug")&&(a.atmosphere.debug("Invoking executeWebSocket"),a.atmosphere.debug("Using URL: "+c)),b&&!e.reconnect)return void(null!=g&&ya());g=K(c),null!=e.webSocketBinaryType&&(g.binaryType=e.webSocketBinaryType),e.connectTimeout>0&&(e.id=setTimeout(function(){if(b);else{var a={code:1002,reason:"",wasClean:!1};g.onclose(a);try{ya()}catch(a){}}},e.connectTimeout)),g.onopen=function(c){A("websocket.onopen"),Q(e),z("debug")&&a.atmosphere.debug("Websocket successfully opened"),a.atmosphere.offline=!1;var d=b;null!=g&&(g.canSendMessage=!0),e.enableProtocol||(b=!0,d?H("re-opening","websocket",e):H("opening","websocket",e)),null!=g&&"POST"===e.method&&(f.state="messageReceived",g.send(e.data))},g.onmessage=function(a){A("websocket.onmessage: "+a),Q(e),e.enableProtocol&&(b=!0),f.state="messageReceived",f.status=200,a=a.data;var c="string"==typeof a;if(c){var d=T(a,e,f);d||(ua(),f.responseBody="",f.messages=[])}else{if(a=P(e,a),""===a)return;f.responseBody=a,ua(),f.responseBody=null}},g.onerror=function(a){A("websocket.onerror"),clearTimeout(e.id),e.heartbeatTimer&&clearTimeout(e.heartbeatTimer)},g.onclose=function(c){if(A("websocket.onclose"),"closed"!==f.state){clearTimeout(e.id);var d=c.reason;if(""===d)switch(c.code){case 1e3:d="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:d="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:d="The endpoint is terminating the connection due to a protocol error.";break;case 1003:d="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:d="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:d="Unknown: no status code was provided even though one was expected.";break;case 1006:d="Connection was closed abnormally (that is, with no close frame being sent)."}if(z("warn")&&(a.atmosphere.warn("Websocket closed, reason: "+d),a.atmosphere.warn("Websocket closed, wasClean: "+c.wasClean)),f.closedByClientTimeout||a.atmosphere.offline)return void(e.reconnectId&&(clearTimeout(e.reconnectId),delete e.reconnectId));ta(b),f.state="closed",p?a.atmosphere.log(e.logLevel,["Websocket closed normally"]):b?e.reconnect&&"websocket"===f.transport&&(ya(),m++<e.maxReconnectOnClose?(H("re-connecting",e.transport,e),e.reconnectInterval>0?e.reconnectId=setTimeout(function(){f.responseBody="",f.messages=[],O(!0)},e.reconnectInterval):(f.responseBody="",f.messages=[],O(!0))):(a.atmosphere.log(e.logLevel,["Websocket reconnect maximum try reached "+e.requestCount]),z("warn")&&a.atmosphere.warn("Websocket error, reason: "+c.reason),S(0,"maxReconnectOnClose reached"))):U("Websocket failed. Downgrading to Comet and resending")}};var d=navigator.userAgent.toLowerCase(),h=d.indexOf("android")>-1;h&&void 0===g.url&&g.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function P(c,d){var f=d;if("polling"===c.transport)return f;if(c.enableProtocol&&c.firstMessage&&0!==a.trim(d).length){var g=c.trackMessageLength?1:0,h=d.split(c.messageDelimiter);if(h.length<=g+1)return f;if(c.firstMessage=!1,c.uuid=a.trim(h[g]),h.length<=g+2&&a.atmosphere.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),n=parseInt(a.trim(h[g+1]),10),o=h[g+2],b=!1,"long-polling"!==c.transport&&W(c),a.atmosphere.uuid=c.uuid,f="",g=c.trackMessageLength?4:3,h.length>g+1)for(var i=g;i<h.length;i++)f+=h[i],i+1!==h.length&&(f+=c.messageDelimiter);0!==c.ackInterval&&setTimeout(function(){fa("...ACK...")},c.ackInterval)}else c.enableProtocol&&c.firstMessage&&a.browser.msie&&+a.browser.version.split(".")[0]<10?a.atmosphere.log(e.logLevel,["Receiving unexpected data from IE"]):W(c);return f}function Q(a){clearTimeout(a.id),a.timeout>0&&"polling"!==a.transport&&(a.id=setTimeout(function(){R(a),wa(),ya()},a.timeout))}function R(a){f.closedByClientTimeout=!0,f.state="closedByClient",f.responseBody="",f.status=408,f.messages=[],ua()}function S(a,b){ya(),clearTimeout(e.id),f.state="error",f.reasonPhrase=b,f.responseBody="",f.status=a,f.messages=[],ua()}function T(a,b,c){if(a=P(b,a),0===a.length)return!0;if(c.responseBody=a,b.trackMessageLength){a=c.partialMessage+a;var d=[],e=a.indexOf(b.messageDelimiter);if(e!=-1){for(;e!==-1;){var f=a.substring(0,e),g=parseInt(f,10);if(isNaN(g))throw'message length "'+f+'" is not a number';e+=b.messageDelimiter.length,e+g>a.length?e=-1:(d.push(a.substring(e,e+g)),a=a.substring(e+g,a.length),e=a.indexOf(b.messageDelimiter))}return c.partialMessage=a,0!==d.length?(c.responseBody=d.join(b.messageDelimiter),c.messages=d,!1):(c.responseBody="",c.messages=[],!0)}}return c.responseBody=a,c.messages=[a],!1}function U(b){a.atmosphere.log(e.logLevel,[b]),"undefined"!=typeof e.onTransportFailure?e.onTransportFailure(b,e):"undefined"!=typeof a.atmosphere.onTransportFailure&&a.atmosphere.onTransportFailure(b,e),e.transport=e.fallbackTransport;var c=e.connectTimeout===-1?0:e.connectTimeout;e.reconnect&&"none"!==e.transport||null==e.transport?(e.method=e.fallbackMethod,f.transport=e.fallbackTransport,e.fallbackTransport="none",c>0?e.reconnectId=setTimeout(function(){E()},c):E()):S(500,"Unable to reconnect with fallback transport")}function V(b,c){var d=e;return null!=b&&"undefined"!=typeof b&&(d=b),null==c&&(c=d.url),d.attachHeadersAsQueryString?c.indexOf("X-Atmosphere-Framework")!==-1?c:(c+=c.indexOf("?")!==-1?"&":"?",c+="X-Atmosphere-tracking-id="+d.uuid,c+="&X-Atmosphere-Framework="+a.atmosphere.version,c+="&X-Atmosphere-Transport="+d.transport,d.trackMessageLength&&(c+="&X-Atmosphere-TrackMessageSize=true"),null!==d.heartbeat&&null!==d.heartbeat.server&&(c+="&X-Heartbeat-Server="+d.heartbeat.server),""!==d.contentType&&(c+="&Content-Type="+("websocket"===d.transport?d.contentType:encodeURIComponent(d.contentType))),d.enableProtocol&&(c+="&X-atmo-protocol=true"),a.each(d.headers,function(e,g){var h=a.isFunction(g)?g.call(this,d,b,f):g;null!=h&&(c+="&"+encodeURIComponent(e)+"="+encodeURIComponent(h))}),c):c}function W(a){if(a.isOpen){if(!a.isReopen)return;a.isReopen=!1,H("re-opening",a.transport,a)}else a.isOpen=!0,H("opening",a.transport,a);X(a)}function X(b){if(null!=b.heartbeatTimer&&clearTimeout(b.heartbeatTimer),!isNaN(n)&&n>0){var c=function(){z("debug")&&a.atmosphere.debug("Sending heartbeat"),fa(o),b.heartbeatTimer=setTimeout(c,n)};b.heartbeatTimer=setTimeout(c,n)}}function Y(b){var d=e;if(null==b&&"undefined"==typeof b||(d=b),d.lastIndex=0,d.readyState=0,"jsonp"===d.transport||d.enableXDR&&a.atmosphere.checkCORSSupport())return void I(d);if("ajax"===d.transport)return void J(b);if(a.browser.msie&&+a.browser.version.split(".")[0]<10){if("streaming"===d.transport)return void(d.enableXDR&&window.XDomainRequest?ba(d):da(d));if(d.enableXDR&&window.XDomainRequest)return void ba(d)}var g=function(a){d.lastIndex=0,a||d.reconnect&&m++<d.maxReconnectOnClose?(f.ffTryingReconnect=!0,H("re-connecting",b.transport,b),_(k,d,b.reconnectInterval)):S(0,"maxReconnectOnClose reached")},h=function(b){a.atmosphere._beforeUnloadState?(a.atmosphere.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){g(b)},5e3)):g(b)},j=function(){f.errorHandled=!0,ya(),h(!1)};if(d.reconnect&&(d.maxRequest===-1||d.requestCount++<d.maxRequest)){var k=a.ajaxSettings.xhr();k.hasData=!1,$(k,d,!0),d.suspend&&(i=k),"polling"!==d.transport&&(f.transport=d.transport,k.onabort=function(){A("ajaxrequest.onabort"),ta(!0)},k.onerror=function(){A("ajaxrequest.onerror"),f.error=!0,f.ffTryingReconnect=!0;try{f.status=XMLHttpRequest.status}catch(a){f.status=500}f.status||(f.status=500),f.errorHandled||(ya(),h(!1))}),k.onreadystatechange=function(){if(A("ajaxRequest.onreadystatechange, new state: "+k.readyState),!p){f.error=null;var g=!1,i=!1;if("streaming"===d.transport&&d.readyState>2&&4===k.readyState)return ya(),void h(!1);if(d.readyState=k.readyState,"streaming"===d.transport&&k.readyState>=3?i=!0:"long-polling"===d.transport&&4===k.readyState&&(i=!0),Q(e),"polling"!==d.transport){var l=200;if(4===k.readyState&&(l=k.status>1e3?0:k.status),!d.reconnectOnServerError&&l>=300&&l<600)return void S(l,k.statusText);if(l>=300||0===l)return void j();d.enableProtocol&&b.firstMessage||2!==k.readyState||(a.browser.mozilla&&f.ffTryingReconnect?(f.ffTryingReconnect=!1,setTimeout(function(){f.ffTryingReconnect||W(d)},500)):W(d))}else 4===k.readyState&&(i=!0);if(i){var m=k.responseText;if("long-polling"===d.transport&&0===a.trim(m).length)return void(k.hasData?k.hasData=!1:h(!0));if(k.hasData=!0,qa(k,e),"streaming"===d.transport)if(a.browser.opera)a.atmosphere.iterate(function(){if(500!==f.status&&k.responseText.length>d.lastIndex){try{f.status=k.status,f.headers=c(k.getAllResponseHeaders()),qa(k,e)}catch(a){f.status=404}Q(e),f.state="messageReceived";var a=k.responseText.substring(d.lastIndex);if(d.lastIndex=k.responseText.length,g=T(a,d,f),g||ua(),va(k,d))return void Z(k,d)}else if(f.status>400)return d.lastIndex=k.responseText.length,!1},0);else{var n=m.substring(d.lastIndex,m.length);if(g=T(n,d,f),d.lastIndex=m.length,g)return}else g=T(m,d,f);var o=va(k,d);try{f.status=k.status,f.headers=c(k.getAllResponseHeaders()),qa(k,d)}catch(a){f.status=404}d.suspend?f.state=0===f.status?"closed":"messageReceived":f.state="messagePublished";var q=!o&&"streaming"!==b.transport&&"polling"!==b.transport;q&&!d.executeCallbackBeforeReconnect&&_(k,d,d.pollingInterval),0===f.responseBody.length||g||ua(),q&&d.executeCallbackBeforeReconnect&&_(k,d,d.pollingInterval),o&&Z(k,d)}}},k.send(d.data),l=!0}else"debug"===d.logLevel&&a.atmosphere.log(d.logLevel,["Max re-connection reached."]),S(0,"maxRequest reached")}function Z(a,b){f.messages=[],b.isReopen=!0,xa(),p=!1,_(a,b,500)}function $(b,c,d){var g=c.url;null!=c.dispatchUrl&&"POST"===c.method&&(g+=c.dispatchUrl),g=V(c,g),g=a.atmosphere.prepareURL(g),d&&(b.open(c.method,g,!0),c.connectTimeout>0&&(c.id=setTimeout(function(){0===c.requestCount&&(ya(),pa("Connect timeout","closed",200,c.transport))},c.connectTimeout))),e.withCredentials&&"websocket"!==e.transport&&"withCredentials"in b&&(b.withCredentials=!0),e.dropHeaders||(b.setRequestHeader("X-Atmosphere-Framework",a.atmosphere.version),b.setRequestHeader("X-Atmosphere-Transport",c.transport),null!==c.heartbeat&&null!==c.heartbeat.server&&b.setRequestHeader("X-Heartbeat-Server",b.heartbeat.server),c.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",c.uuid),a.each(c.headers,function(e,g){var h=a.isFunction(g)?g.call(this,b,c,d,f):g;null!=h&&b.setRequestHeader(e,h)})),""!==c.contentType&&b.setRequestHeader("Content-Type",c.contentType)}function _(a,b,c){if(!f.closedByClientTimeout&&(b.reconnect||b.suspend&&l)){var d=0;a.readyState>1&&(d=a.status>1e3?0:a.status),f.status=0===d?204:d,f.reason=0===d?"Server resumed the connection or down.":"OK",clearTimeout(b.id),b.reconnectId&&(clearTimeout(b.reconnectId),delete b.reconnectId),c>0?setTimeout(function(){e.reconnectId=Y(b)},c):Y(b)}}function aa(a){a.state="re-connecting",ra(a)}function ba(a){"polling"!==a.transport?(j=ca(a),j.open()):ca(a).open()}function ca(b){var c=e;null!=b&&"undefined"!=typeof b&&(c=b);var d=c.transport,g=0,h=new window.XDomainRequest,i=function(){"long-polling"===c.transport&&c.reconnect&&(c.maxRequest===-1||c.requestCount++<c.maxRequest)&&(h.status=200,H("re-connecting",b.transport,b),ba(c))},j=c.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case"JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case"PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};h.onprogress=function(){k(h)},h.onerror=function(){"polling"!==c.transport&&(ya(),m++<c.maxReconnectOnClose?c.reconnectInterval>0?c.reconnectId=setTimeout(function(){H("re-connecting",b.transport,b),ba(c)},c.reconnectInterval):(H("re-connecting",b.transport,b),ba(c)):S(0,"maxReconnectOnClose reached"))},h.onload=function(){};var k=function(b){clearTimeout(c.id);var e=b.responseText;if(e=e.substring(g),g+=e.length,"polling"!==d){Q(c);var h=T(e,c,f);if("long-polling"===d&&0===a.trim(e).length)return;c.executeCallbackBeforeReconnect&&i(),h||pa(f.responseBody,"messageReceived",200,d),c.executeCallbackBeforeReconnect||i()}};return{open:function(){var a=c.url;null!=c.dispatchUrl&&(a+=c.dispatchUrl),a=V(c,a),h.open(c.method,j(a)),"GET"===c.method?h.send():h.send(c.data),c.connectTimeout>0&&(c.id=setTimeout(function(){0===c.requestCount&&(ya(),pa("Connect timeout","closed",200,c.transport))},c.connectTimeout))},close:function(){h.abort()}}}function da(a){j=ea(a),j.open()}function ea(b){var c=e;null!=b&&"undefined"!=typeof b&&(c=b);var d,g=new window.ActiveXObject("htmlfile");g.open(),g.close();var h=c.url;return null!=c.dispatchUrl&&(h+=c.dispatchUrl),"polling"!==c.transport&&(f.transport=c.transport),{open:function(){var b=g.createElement("iframe");h=V(c),""!==c.data&&(h+="&X-Atmosphere-Post-Body="+encodeURIComponent(c.data)),h=a.atmosphere.prepareURL(h),b.src=h,g.body.appendChild(b);var i=b.contentDocument||b.contentWindow.document;d=a.atmosphere.iterate(function(){try{if(!i.firstChild)return;if("complete"===i.readyState)try{a.noop(i.fileSize)}catch(a){return pa("Connection Failure","error",500,c.transport),!1}var b=i.body?i.body.lastChild:i,h=function(){var a=b.cloneNode(!0);a.appendChild(i.createTextNode("."));var c=a.innerText;return c=c.substring(0,c.length-1)};if(!a.nodeName(b,"pre")){var j=i.head||i.getElementsByTagName("head")[0]||i.documentElement||i,k=i.createElement("script");k.text="document.write('<plaintext>')",j.insertBefore(k,j.firstChild),j.removeChild(k),b=i.body.lastChild}return c.closed&&(c.isReopen=!0),d=a.atmosphere.iterate(function(){var a=h();if(a.length>c.lastIndex){Q(e),f.status=200,f.error=null,b.innerText="";var d=T(a,c,f);if(d)return"";pa(f.responseBody,"messageReceived",200,c.transport)}if(c.lastIndex=0,"complete"===i.readyState)return ta(!0),H("re-connecting",c.transport,c),c.reconnectInterval>0?c.reconnectId=setTimeout(function(){da(c)},c.reconnectInterval):da(c),!1},null),!1}catch(a){return f.error=!0,H("re-connecting",c.transport,c),m++<c.maxReconnectOnClose?c.reconnectInterval>0?c.reconnectId=setTimeout(function(){da(c)},c.reconnectInterval):da(c):S(0,"maxReconnectOnClose reached"),g.execCommand("Stop"),g.close(),!1}})},close:function(){d&&d(),g.execCommand("Stop"),ta(!0)}}}function fa(b){null!=s?ga(b):null!=i||null!=h?ia(b):null!=j?ja(b):null!=k?ka(b):null!=g?na(b):(S(0,"No suspended connection available"),a.atmosphere.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking trying to push data"))}function ga(a){s.send(a)}function ha(b){if(0!==b.length)try{s?s.localSend(b):r&&r.signal("localMessage",a.stringifyJSON({id:t,event:b}))}catch(b){a.atmosphere.error(b)}}function ia(a){var b=ma(a);Y(b)}function ja(b){if(e.enableXDR&&a.atmosphere.checkCORSSupport()){var c=ma(b);c.reconnect=!1,I(c)}else ia(b)}function ka(a){ia(a)}function la(a){var b=a;return"object"==typeof b&&(b=a.data),b}function ma(b){var c=la(b),d={connected:!1,timeout:6e4,method:"POST",url:e.url,contentType:e.contentType,headers:e.headers,reconnect:!0,callback:null,data:c,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:e.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:e.enableXDR,uuid:e.uuid,dispatchUrl:e.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:e.trackMessageLength,maxReconnectOnClose:e.maxReconnectOnClose,heartbeatTimer:e.heartbeatTimer,heartbeat:e.heartbeat};return"object"==typeof b&&(d=a.extend(d,b)),d}function na(b){var d,c=a.atmosphere.isBinary(b)?b:la(b);try{if(d=null!=e.dispatchUrl?e.webSocketPathDelimiter+e.dispatchUrl+e.webSocketPathDelimiter+c:c,!g.canSendMessage)return void a.atmosphere.error("WebSocket not connected.");g.send(d)}catch(a){g.onclose=function(a){},ya(),U("Websocket failed. Downgrading to Comet and resending "+b),ia(b)}}function oa(b){var c=a.parseJSON(b);c.id!==t&&("undefined"!=typeof e.onLocalMessage?e.onLocalMessage(c.event):"undefined"!=typeof a.atmosphere.onLocalMessage&&a.atmosphere.onLocalMessage(c.event))}function pa(a,b,c,d){f.responseBody=a,f.transport=d,f.status=c,f.state=b,ua()}function qa(b,c){if(c.readResponsesHeaders)try{var d=b.getResponseHeader("X-Atmosphere-tracking-id");d&&null!=d&&(c.uuid=d.split(" ").pop())}catch(a){}else c.enableProtocol||(c.uuid=a.atmosphere.guid())}function ra(b){sa(b,e),sa(b,a.atmosphere)}function sa(a,b){switch(a.state){case"messageReceived":A("Firing onMessage"),m=0,"undefined"!=typeof b.onMessage&&b.onMessage(a);break;case"error":A("Firing onError"),"undefined"!=typeof b.onError&&b.onError(a);break;case"opening":A("Firing onOpen"),delete e.closed,"undefined"!=typeof b.onOpen&&b.onOpen(a);break;case"messagePublished":A("Firing onMessagePublished"),"undefined"!=typeof b.onMessagePublished&&b.onMessagePublished(a);break;case"re-connecting":A("Firing onReconnect"),"undefined"!=typeof b.onReconnect&&b.onReconnect(e,a);break;case"closedByClient":A("Firing onClientTimeout"),"undefined"!=typeof b.onClientTimeout&&b.onClientTimeout(e);break;case"re-opening":A("Firing onReopen"),delete e.closed,"undefined"!=typeof b.onReopen&&b.onReopen(e,a);break;case"fail-to-reconnect":A("Firing onFailureToReconnect"),"undefined"!=typeof b.onFailureToReconnect&&b.onFailureToReconnect(e,a);break;case"unsubscribe":case"closed":var c="undefined"!=typeof e.closed&&e.closed;c?A("Closed but not firing onClose"):(A("Firing onClose"),"undefined"!=typeof b.onClose&&b.onClose(a)),e.closed=!0}}function ta(a){"closed"!==f.state&&(f.state="closed",f.responseBody="",f.messages=[],f.status=a?200:501,ua())}function ua(){var b=function(a,b){b(f)};null==s&&null!=q&&q(f.responseBody),e.reconnect=e.mrequest;for(var c="string"==typeof f.responseBody,d=c&&e.trackMessageLength?f.messages.length>0?f.messages:[""]:new Array(f.responseBody),g=0;g<d.length;g++)if(!(d.length>1&&0===d[g].length||(f.responseBody=c?a.trim(d[g]):d[g],null==s&&null!=q&&q(f.responseBody),(0===f.responseBody.length||c&&o===f.responseBody)&&"messageReceived"===f.state))){if(ra(f),a.atmosphere.callbacks.length>0){z("debug")&&a.atmosphere.debug("Invoking "+a.atmosphere.callbacks.length+" global callbacks: "+f.state);try{a.each(a.atmosphere.callbacks,b)}catch(b){a.atmosphere.log(e.logLevel,["Callback exception"+b])}}if("function"==typeof e.callback){z("debug")&&a.atmosphere.debug("Invoking request callbacks");try{e.callback(f)}catch(b){a.atmosphere.log(e.logLevel,["Callback exception"+b])}}}}function va(a,b){return""===f.partialMessage&&"streaming"===b.transport&&a.responseText.length>b.maxStreamingLength}function wa(){if(e.enableProtocol&&!e.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+e.uuid;a.each(e.headers,function(c,d){var g=a.isFunction(d)?d.call(this,e,e,f):d;null!=g&&(b+="&"+encodeURIComponent(c)+"="+encodeURIComponent(g))});var c=e.url.replace(/([?&])_=[^&]*/,b);c+=c===e.url?(/\?/.test(e.url)?"&":"?")+b:"",e.connectTimeout>0?a.ajax({url:c,async:e.closeAsync,timeout:e.connectTimeout,cache:!1,crossDomain:e.enableXDR}):a.ajax({url:c,async:e.closeAsync,cache:!1,crossDomain:e.enableXDR})}}function xa(){e.reconnectId&&(clearTimeout(e.reconnectId),delete e.reconnectId),e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),e.reconnect=!1,p=!0,f.request=e,f.state="unsubscribe",f.responseBody="",f.status=408,ua(),wa(),ya()}function ya(){f.partialMessage="",e.id&&clearTimeout(e.id),e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),e.reconnectId&&(clearTimeout(e.reconnectId),delete e.reconnectId),null!=j&&(j.close(),j=null),null!=k&&(k.abort(),k=null),null!=i&&(i.abort(),i=null),null!=g&&(g.canSendMessage&&g.close(),g=null),null!=h&&(h.close(),h=null),za()}function za(){null!=r&&(clearInterval(u),document.cookie=v+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",r.signal("close",{reason:"",heir:p?(r.get("children")||[])[0]:t}),r.close()),null!=s&&s.close()}var r,u,v,e={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",
data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,onError:function(a){},onClose:function(a){},onOpen:function(a){},onMessage:function(a){},onReopen:function(a,b){},onReconnect:function(a,b){},onMessagePublished:function(a){},onTransportFailure:function(a,b){},onLocalMessage:function(a){},onFailureToReconnect:function(a,b){},onClientTimeout:function(a){}},f={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},g=null,h=null,i=null,j=null,k=null,l=!0,m=0,n=0,o="X",p=!1,q=null,s=null,t=a.now();B(d),this.subscribe=function(a){B(a),E()},this.execute=function(){E()},this.invokeCallback=function(){ua()},this.close=function(){xa()},this.disconnect=function(){wa()},this.getUrl=function(){return e.url},this.push=function(a,b){if(null!=b){var c=e.dispatchUrl;e.dispatchUrl=b,fa(a),e.dispatchUrl=c}else fa(a)},this.getUUID=function(){return e.uuid},this.pushLocal=function(a){ha(a)},this.enableProtocol=function(a){return e.enableProtocol},this.init=function(){x()},this.request=e,this.response=f},subscribe:function(b,c,d){"function"==typeof c&&a.atmosphere.addCallback(c),"string"!=typeof b?d=b:d.url=b,a.atmosphere.uuid="undefined"!=typeof d&&"undefined"!=typeof d.uuid?d.uuid:0;var e=new a.atmosphere.AtmosphereRequest(d);return e.execute(),a.atmosphere.requests[a.atmosphere.requests.length]=e,e},addCallback:function(b){a.inArray(b,a.atmosphere.callbacks)===-1&&a.atmosphere.callbacks.push(b)},removeCallback:function(b){var c=a.inArray(b,a.atmosphere.callbacks);c!==-1&&a.atmosphere.callbacks.splice(c,1)},unsubscribe:function(){if(a.atmosphere.requests.length>0)for(var b=[].concat(a.atmosphere.requests),c=0;c<b.length;c++){var d=b[c];d.close(),clearTimeout(d.response.request.id),d.heartbeatTimer&&clearTimeout(d.heartbeatTimer)}a.atmosphere.requests=[],a.atmosphere.callbacks=[]},unsubscribeUrl:function(b){var c=-1;if(a.atmosphere.requests.length>0)for(var d=0;d<a.atmosphere.requests.length;d++){var e=a.atmosphere.requests[d];if(e.getUrl()===b){e.close(),clearTimeout(e.response.request.id),e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),c=d;break}}c>=0&&a.atmosphere.requests.splice(c,1)},publish:function(b){"function"==typeof b.callback&&a.atmosphere.addCallback(b.callback),b.transport="polling";var c=new a.atmosphere.AtmosphereRequest(b);return a.atmosphere.requests[a.atmosphere.requests.length]=c,c},checkCORSSupport:function(){if(a.browser.msie&&!window.XDomainRequest&&+a.browser.version.split(".")[0]<11)return!0;if(a.browser.opera&&+a.browser.version.split(".")[0]<12)return!0;if("KreaTVWebKit/531"===a.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===a.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var b=navigator.userAgent.toLowerCase(),c=b.indexOf("android")>-1;return!!c},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return a.atmosphere.S4()+a.atmosphere.S4()+"-"+a.atmosphere.S4()+"-"+a.atmosphere.S4()+"-"+a.atmosphere.S4()+"-"+a.atmosphere.S4()+a.atmosphere.S4()+a.atmosphere.S4()},prepareURL:function(b){var c=a.now(),d=b.replace(/([?&])_=[^&]*/,"$1_="+c);return d+(d===b?(/\?/.test(b)?"&":"?")+"_="+c:"")},param:function(b){return a.param(b,a.ajaxSettings.traditional)},supportStorage:function(){var b=window.localStorage;if(b)try{return b.setItem("t","t"),b.removeItem("t"),window.StorageEvent&&!a.browser.msie&&!(a.browser.mozilla&&"1"===a.browser.version.split(".")[0])}catch(a){}return!1},iterate:function(a,b){var c;return b=b||0,function d(){c=setTimeout(function(){a()!==!1&&d()},b)}(),function(){clearTimeout(c)}},log:function(a,b){if(window.console){var c=window.console[a];"function"==typeof c&&c.apply(window.console,b)}},warn:function(){a.atmosphere.log("warn",arguments)},info:function(){a.atmosphere.log("info",arguments)},debug:function(){a.atmosphere.log("debug",arguments)},error:function(){a.atmosphere.log("error",arguments)},isBinary:function(a){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(a))}},function(){var b,c;a.uaMatch=function(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(a)||a.indexOf("android")<0&&/version\/(.+) (safari)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return"safari"===b[2]&&(b[2]=b[1],b[1]="safari"),{browser:b[1]||"",version:b[2]||"0"}},b=a.uaMatch(navigator.userAgent),c={},b.browser&&(c[b.browser]=!0,c.version=b.version,c.vmajor=c.version.split(".")[0]),c.trident&&(c.msie=!0),a.browser=c,a.sub=function(){function b(a,c){return new b.fn.init(a,c)}a.extend(!0,b,this),b.superclass=this,b.fn=b.prototype=this(),b.fn.constructor=b,b.sub=this.sub,b.fn.init=function(e,f){return f&&f instanceof a&&!(f instanceof b)&&(f=b(f)),a.fn.init.call(this,e,f,c)},b.fn.init.prototype=b.fn;var c=b(document);return b}}(),function(a){function d(a){return'"'+a.replace(b,function(a){var b=c[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function e(a){return a<10?"0"+a:a}function f(a,b){var c,g,h,i,j=b[a],k=typeof j;switch(j&&"object"==typeof j&&"function"==typeof j.toJSON&&(j=j.toJSON(a),k=typeof j),k){case"string":return d(j);case"number":return isFinite(j)?String(j):"null";case"boolean":return String(j);case"object":if(!j)return"null";switch(Object.prototype.toString.call(j)){case"[object Date]":return isFinite(j.valueOf())?'"'+j.getUTCFullYear()+"-"+e(j.getUTCMonth()+1)+"-"+e(j.getUTCDate())+"T"+e(j.getUTCHours())+":"+e(j.getUTCMinutes())+":"+e(j.getUTCSeconds())+'Z"':"null";case"[object Array]":for(h=j.length,i=[],c=0;c<h;c++)i.push(f(c,j)||"null");return"["+i.join(",")+"]";default:i=[];for(c in j)Object.prototype.hasOwnProperty.call(j,c)&&(g=f(c,j),g&&i.push(d(c)+":"+g));return"{"+i.join(",")+"}"}}}var b=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};a.stringifyJSON=function(a){return window.JSON&&window.JSON.stringify?window.JSON.stringify(a):f("",{"":a})}}(a)});